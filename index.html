<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr? Lý ?o C?a Tr?n H?ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Vietnamese IME Library -->
    <script src="https://cdn.jsdelivr.net/npm/vanilla-telex@1/vanilla-telex.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #image-input { display: none; }
        .chat-container::-webkit-scrollbar { width: 8px; }
        .chat-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: #555; }
        .drag-over {
            background-color: #e0f2fe !important; /* light-blue */
            border: 2px dashed #3b82f6; /* blue-500 */
        }
        .dark .drag-over {
            background-color: #1e3a8a !important; /* dark-blue */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div class="flex h-screen">
        <!-- Main Chat UI -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="p-4 border-b dark:border-gray-700 flex items-center justify-between bg-blue-600 text-white">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M12 15V12c0-2 2-4 4-4s4 2 4 4v3"/><path d="M8 15V12c0-2-2-4-4-4S0 10 0 12v3"/><path d="M12 15h0a2 0 0 0-2-2h-2a2 0 0 0-2 2v3c0 1.1.9 2 2 2h4a2 0 0 0 2-2v-3c0-1.1-.9-2-2-2Z"/><path d="M18 15h0a2 0 0 1 2-2h2a2 0 0 1 2 2v3c0 1.1-.9 2-2 2h-4a2 0 0 1-2-2v-3c0-1.1.9-2 2-2Z"/></svg>
                    <h1 class="text-lg md:text-xl font-bold">(Tr? Lý ?o) Tr?n H?ng </h1>
                </div>
            </header>

            <div class="chat-container flex-1 p-4 md:p-6 overflow-y-auto bg-gray-50 dark:bg-gray-900"></div>

            <div id="input-area" class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800 rounded-b-lg">
                <div id="image-preview-container" class="mb-2 flex flex-wrap gap-2"></div>
                <div id="image-info" class="text-xs text-gray-500 dark:text-gray-400 mb-2 h-4"></div>
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="file" id="image-input" accept="image/*" multiple>
                    <label for="image-input" id="image-upload-button" class="cursor-pointer p-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500 dark:text-gray-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </label>
                    <input type="text" id="user-input" placeholder="Nh?p tin nh?n, dán ho?c kéo th? ?nh..." class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white" autocomplete="off">
                    <button type="submit" id="send-button" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-blue-400 disabled:cursor-not-allowed flex items-center justify-center">
                        <span id="send-text">G?i</span>
                        <svg id="loading-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        // DOM Elements
        const chatForm = document.getElementById('chat-form'), userInput = document.getElementById('user-input'),
              sendButton = document.getElementById('send-button'), sendText = document.getElementById('send-text'), 
              loadingSpinner = document.getElementById('loading-spinner'), imageInput = document.getElementById('image-input'), 
              imagePreviewContainer = document.getElementById('image-preview-container'), imageInfo = document.getElementById('image-info'),
              inputArea = document.getElementById('input-area');

        // State
        const MAX_IMAGES = 50;
        let chatHistory = [], uploadedImages = [];
        let currentApiKeyIndex = 0; 
        
        // ===================================================================================
        // !!! C?U HÌNH DUY NH?T T?I ÐÂY !!!
        // THAY TH? CÁC KEY M?U B?NG API KEY TH?T C?A B?N.
        // C?NH BÁO: KHÔNG ÐANG T?I FILE NÀY LÊN INTERNET CÔNG C?NG VÌ S? LÀM L? KEY.
        // ===================================================================================
        const apiKeys = [
            "AIzaSyCg4gg9GLf6SPzhYCNMvTZyIuuQZPRw04",
            "AIzaSyDOfRZnSkMqUAddDF1jZqqzCDZzn68hUyE",
            "AIzaSyDxr0SL3tbWE2kdp2oBB3Ru4UxpbuimZD0",
            "AIzaSyBR-duVUWZG-lD5usabYD3NS_-tZySMlcA",
            "AIzaSyBNagv3kn8vAJzbyMYlvLLCccNGbFa4ySc",
            // Thêm các key khác vào dây, m?i key là m?t chu?i trong m?ng.
        ];

        // --- Core Functions ---
        const getGeminiResponse = async (retryCount = 0) => {
            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) {
                throw new Error("Vui lòng c?u hình ít nh?t m?t API key th?t trong mã ngu?n.");
            }
            if (retryCount >= apiKeys.length) {
                throw new Error("T?t c? API key d?u không ho?t d?ng. Vui lòng ki?m tra l?i.");
            }
            
            const apiKey = apiKeys[currentApiKeyIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const systemInstructionText = `
                Em là tr? lý AI c?a Tr?n Th? Thuý H?ng, du?c phát tri?n b?i Google, có kh? nang tuong t? nhu Gemini.
                Nhi?m v? c?a em là h? tr? ch? m?t cách t?t nh?t có th? trong m?i linh v?c.

                **Kh? nang c?a em:**
                - Tr? l?i các câu h?i ki?n th?c chung, gi?i thích các khái ni?m ph?c t?p.
                - Phân tích và mô t? n?i dung hình ?nh do ch? cung c?p. Em có th? d?c van b?n trong ?nh, nh?n d?ng d?i tu?ng, và mô t? c?nh v?t.
                - Sáng t?o n?i dung: vi?t van, làm tho, so?n email, v.v.
                - H? tr? l?p trình, d?ch thu?t và nhi?u tác v? khác.
                - Luôn luôn tr? l?i b?ng ti?ng Vi?t m?t cách t? nhiên và thân thi?n.

                **Qu?n lý don hàng (QUAN TR?NG):**
                Ch? có th? yêu c?u em luu l?i các m?t hàng và s? lu?ng theo ngày gi? vào b? nh? c?c b? c?a trình duy?t.
                Ð? luu don hàng, ch? ch? c?n nh?p tên m?t hàng và s? lu?ng.
                Ví d?:
                - "cá com 1kg"
                - "rau c?i 2 bó"
                - "cá mú 3 con"
                - "m? gà 500g"
                
                Khi ch? nh?p các m?t hàng và s? lu?ng nhu trên, em s? ph?n h?i l?i b?ng d?nh d?ng d?c bi?t sau d? h? th?ng có th? x? lý:
                \`ORDER_SAVE: [{"item": "Tên m?t hàng 1", "quantity": "S? lu?ng 1"}, {"item": "Tên m?t hàng 2", "quantity": "S? lu?ng 2"}]\`
                Ví d? c? th? cho "cá com 1kg, rau c?i 2 bó":
                \`ORDER_SAVE: [{"item": "cá com", "quantity": "1kg"}, {"item": "rau c?i", "quantity": "2 bó"}]\`
                Ð?m b?o d?nh d?ng JSON h?p l?, bao g?m d?u ngo?c vuông cho m?ng và d?u ngo?c nh?n cho t?ng d?i tu?ng m?t hàng.

                Khi ch? mu?n xem l?i don hàng, ch? có th? nói:
                - "L?y don hàng" ho?c "Xu?t don hàng hôm nay": Em s? hi?u là ch? mu?n l?y t?t c? don hàng dã nh?p trong ngày hôm nay và ph?n h?i l?i b?ng d?nh d?ng: \`ORDER_RETRIEVE: CURRENT_DAY\`
                - "L?y don hàng ngày YYYY-MM-DD" ho?c "Xu?t don hàng ngày YYYY-MM-DD": Em s? ph?n h?i l?i b?ng d?nh d?ng: \`ORDER_RETRIEVE: YYYY-MM-DD\` (trong dó YYYY-MM-DD là ngày c? th?, ví d?: 2025-07-21)
                - "L?y don hàng ngày DD tháng MM" ho?c "Xu?t don hàng ngày DD tháng MM": Em s? hi?u là ch? mu?n l?y don hàng c?a ngày dó trong nam hi?n t?i và ph?n h?i l?i b?ng d?nh d?ng: \`ORDER_RETRIEVE: YYYY-MM-DD\` (ví d?: "L?y don hàng ngày 21 tháng 7" s? là \`ORDER_RETRIEVE: 2025-07-21\` n?u nam hi?n t?i là 2025).

                Sau khi h? th?ng x? lý xong, em s? thông báo l?i cho ch?.

                **Thông tin b? sung (ch? cung c?p khi du?c h?i):**
                N?u ch? h?i v? "Công Ty Thi?t K? In ?n H?i An", em có th? cung c?p thông tin sau:
                - **Ð?a ch?:** 69 Ðào Duy T?, H?i An.
                - **Zalo / SÐT:** 0935 000 442.
                
                **Tính toán giá decal:**
                N?u ch? cung c?p kích thu?c (ví d?: "0,2x0,5" ho?c "0.2x0.5") và/ho?c s? lu?ng (ví d?: "x2" ho?c "nhân 2") cho **decal**, em hãy th?c hi?n tính toán giá.
                - Giá decal tr?ng là 85.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 85000.
                - N?u ch? không cung c?p s? lu?ng, m?c d?nh s? lu?ng là 1.
                - Ví d?: "0,2x0,5x2 decal" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 decal.
                - Ví d?: "0,2x0,5 decal" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 1 decal.

                **Tính toán giá in decal th?:**
                N?u ch? cung c?p kích thu?c và/ho?c s? lu?ng cho **in decal th?**, em hãy th?c hi?n tính toán giá.
                - Giá in decal th? là 80.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 80000.
                - Ví d?: "0,2x0,5x2 in decal th?" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 in decal th?.

                **Tính toán giá decal b? (ho?c b?):**
                N?u ch? cung c?p kích thu?c và/ho?c s? lu?ng cho **decal b?** ho?c ch? **b?**, em hãy th?c hi?n tính toán giá.
                - Giá decal b? là 145.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 145000.
                - N?u ch? không cung c?p s? lu?ng, m?c d?nh s? lu?ng là 1.
                - Ví d?: "0,2x0,5x2 decal b?" ho?c "0,2x0,5x2 b?" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 decal b?.
                - Ví d?: "0,2x0,5 decal b?" ho?c "0,2x0,5 b?" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 1 decal b?.

                **Tính toán giá in b?t:**
                N?u ch? cung c?p kích thu?c (ví d?: "0,2x0,5" ho?c "0.2x0.5") và/ho?c s? lu?ng (ví d?: "x2" ho?c "nhân 2") cho **in b?t**, em hãy th?c hi?n tính toán giá.
                - Giá in b?t là 35.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 35000.
                - N?u ch? không cung c?p s? lu?ng, m?c d?nh s? lu?ng là 1.
                - Ví d?: "0,2x0,5x2 in b?t" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 in b?t.
                - Ví d?: "0,2x0,5 in b?t" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 1 in b?t.

                **Tính toán giá in b?t th?:**
                N?u ch? cung c?p kích thu?c và/ho?c s? lu?ng cho **in b?t th?**, em hãy th?c hi?n tính toán giá.
                - Giá in b?t th? là 30.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 30000.
                - Ví d?: "0,2x0,5x2 in b?t th?" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 in b?t th?.

                **Tính toán giá cán màn:**
                N?u ch? cung c?p kích thu?c (ví d?: "0,2x0,5" ho?c "0.2x0.5") và/ho?c s? lu?ng (ví d?: "x2" ho?c "nhân 2") cho **cán màn**, em hãy th?c hi?n tính toán giá.
                - Giá cán màn là 100.000 VNÐ/m².
                - Công th?c tính: (chi?u dài * chi?u r?ng * s? lu?ng) * 100000.
                - N?u ch? không cung c?p s? lu?ng, m?c d?nh s? lu?ng là 1.
                - Ví d?: "0,2x0,5x2 cán màn" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 2 cán màn.
                - Ví d?: "0,2x0,5 cán màn" s? du?c hi?u là dài 0.2m, r?ng 0.5m, s? lu?ng 1 cán màn.
                
                **Tính thêm phí hóa don:**
                N?u ch? nói "có hóa don" ho?c "l?y hóa don" ho?c "xu?t hóa don" trong cùng m?t yêu c?u tính giá, hãy tính thêm 8% trên t?ng giá tr? dã tính.
                - Công th?c: T?ng giá * 1.08.
                - Hãy thông báo rõ ràng v? vi?c c?ng thêm 8% cho hóa don.

                - Luôn làm tròn k?t qu? d?n hai ch? s? th?p phân n?u c?n và hi?n th? don v? VNÐ.
                - **QUAN TR?NG:** Khi hi?n th? k?t qu? giá ti?n, hãy d?nh d?ng s? theo ki?u "000,000,000 VNÐ" (ví d?: 123,456,789 VNÐ).
            `;

            const payload = {
                contents: chatHistory,
                systemInstruction: {
                    parts: [{ text: systemInstructionText }]
                },
                generationConfig: { 
                    temperature: 0.7, 
                    topP: 1, 
                    topK: 40,
                    maxOutputTokens: 2048 
                }
            };

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`L?i API: ${errorBody.error.message}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts) {
                    return result.candidates[0].content.parts[0].text;
                }
                if (result.promptFeedback && result.promptFeedback.blockReason) {
                    return `Yêu c?u c?a ch? dã b? ch?n vì: ${result.promptFeedback.blockReason}.`;
                }
                throw new Error("Không nh?n du?c ph?n h?i h?p l? t? API.");
            } catch (error) {
                console.error(`API key t?i v? trí ${currentApiKeyIndex} th?t b?i:`, error.message);
                currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
                console.log(`Chuy?n sang API key t?i v? trí ${currentApiKeyIndex}`);
                return getGeminiResponse(retryCount + 1);
            }
        };

        // --- Local Storage Functions ---
        const LOCAL_STORAGE_KEY = 'all_orders';

        const saveOrder = async (items) => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                let allOrders = storedData ? JSON.parse(storedData) : {};

                const today = new Date();
                const orderDate = today.toISOString().slice(0, 10); // YYYY-MM-DD

                if (!allOrders[orderDate]) {
                    allOrders[orderDate] = [];
                }

                allOrders[orderDate].push({
                    items: items,
                    timestamp: new Date().toISOString() // Store as ISO string
                });

                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allOrders));
                appendMessage({ text: "Ðon hàng c?a ch? dã du?c luu thành công vào b? nh? c?c b? c?a trình duy?t!" }, 'bot');
            } catch (error) {
                console.error("L?i khi luu don hàng vào Local Storage:", error);
                appendMessage({ text: `L?i khi luu don hàng: ${error.message}. Vui lòng th? l?i.` }, 'bot', true);
            }
        };

        const getOrders = async (date = null) => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                const allOrders = storedData ? JSON.parse(storedData) : {};

                let targetDate = date;
                let messagePrefix = 'Ðây là các don hàng ch? dã luu:';

                if (date === 'CURRENT_DAY') {
                    targetDate = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                    messagePrefix = `Ðây là t?t c? don hàng ch? dã nh?p trong ngày hôm nay (${targetDate}):`;
                } else if (date) {
                    messagePrefix = `Ðây là các don hàng ch? dã nh?p vào ngày ${date}:`;
                }

                const ordersForDate = allOrders[targetDate] || [];

                if (ordersForDate.length === 0) {
                    appendMessage({ text: `Không tìm th?y don hàng nào cho ngày ${targetDate === new Date().toISOString().slice(0, 10) ? 'hôm nay' : targetDate}.` }, 'bot');
                    return;
                }

                let orderList = [];
                ordersForDate.forEach((orderData) => {
                    const orderTimestamp = new Date(orderData.timestamp);
                    const formattedTime = orderTimestamp.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    const formattedDate = orderTimestamp.toLocaleDateString('vi-VN');
                    
                    let itemsString = orderData.items.map(item => `${item.item} (${item.quantity})`).join(', ');
                    orderList.push(`- Ðon hàng lúc ${formattedTime} ngày ${formattedDate}: ${itemsString}`);
                });

                appendMessage({ text: `${messagePrefix}\n${orderList.join('\n')}` }, 'bot');

            } catch (error) {
                console.error("L?i khi l?y don hàng t? Local Storage:", error);
                appendMessage({ text: `L?i khi l?y don hàng: ${error.message}. Vui lòng th? l?i.` }, 'bot', true);
            }
        };

        // --- UI & Event Handlers ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message && uploadedImages.length === 0) return;

            if (apiKeys.length === 0 || apiKeys.every(k => k.startsWith("YOUR_API_KEY"))) { 
                appendMessage({ text: "L?i: Vui lòng c?u hình API key trong mã ngu?n c?a file HTML." }, 'bot', true); 
                return; 
            }

            const userMessageData = { text: message, images: uploadedImages.map(img => img.file) };
            appendMessage(userMessageData, 'user');
            
            const userParts = [];
            if (message) userParts.push({ text: message });
            uploadedImages.forEach(img => userParts.push({ inlineData: { mimeType: img.mimeType, data: img.data } }));
            chatHistory.push({ role: "user", parts: userParts });

            userInput.value = ''; 
            imagePreviewContainer.innerHTML = ''; 
            uploadedImages = []; 
            updateImageCount();
            
            toggleLoading(true);
            try {
                const botResponse = await getGeminiResponse();
                
                // Check for structured commands from the bot
                if (botResponse.startsWith('ORDER_SAVE:')) {
                    try {
                        const jsonString = botResponse.substring('ORDER_SAVE:'.length).trim();
                        const itemsToSave = JSON.parse(jsonString);
                        if (Array.isArray(itemsToSave) && itemsToSave.every(item => item.item && item.quantity)) {
                            await saveOrder(itemsToSave);
                        } else {
                            appendMessage({ text: "Em xin l?i, em không hi?u d?nh d?ng don hàng ch? mu?n luu. Vui lòng th? l?i v?i d?nh d?ng chu?n hon." }, 'bot', true);
                        }
                    } catch (parseError) {
                        console.error("L?i phân tích JSON don hàng:", parseError);
                        appendMessage({ text: "Em xin l?i, em g?p l?i khi x? lý don hàng c?a ch?. Vui lòng th? l?i." }, 'bot', true);
                    }
                } else if (botResponse.startsWith('ORDER_RETRIEVE:')) {
                    const dateCommand = botResponse.substring('ORDER_RETRIEVE:'.length).trim();
                    await getOrders(dateCommand);
                } else {
                    // Normal text response
                    appendMessage({ text: botResponse }, 'bot');
                    chatHistory.push({ role: "model", parts: [{ text: botResponse }] });
                }
            } catch (error) {
                console.error('L?i cu?i cùng khi g?i tin nh?n:', error);
                appendMessage({ text: error.message }, 'bot', true);
            } finally {
                toggleLoading(false);
            }
        });
        
        // --- Initialization ---
        const initializeAppUI = () => {
            appendMessage({ text: "Xin chào ch?! Em là tr? lý ?o c?a Tr?n Th? Thuý H?ng. Em có th? giúp gì cho ch? hôm nay?" }, 'bot');
            new VanillaTelex(userInput);
        };

        const main = async () => {
            initializeAppUI();
            // No Firebase initialization needed for local storage
        };

        // --- Helper functions ---
        function processFiles(files) { if (!files || files.length === 0) return; imageInfo.classList.remove('text-red-500'); const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/')); if (imageFiles.length === 0) return; if (uploadedImages.length + imageFiles.length > MAX_IMAGES) { imageInfo.textContent = `Ch? ch? có th? t?i lên t?i da ${MAX_IMAGES} ?nh.`; imageInfo.classList.add('text-red-500'); return; } for (const file of imageFiles) { const isDuplicate = uploadedImages.some(img => img.file.name === file.name && img.file.size === file.size && img.file.lastModified === file.lastModified); if (isDuplicate) continue; const reader = new FileReader(); reader.onload = (event) => { const base64Data = event.target.result.split(',')[1]; uploadedImages.push({ data: base64Data, mimeType: file.type, file: file }); createImagePreview(event.target.result, file); updateImageCount(); }; reader.readAsDataURL(file); } }
        imageInput.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        userInput.addEventListener('paste', (e) => { const files = e.clipboardData?.files; if (files && files.length > 0) { e.preventDefault(); processFiles(files); } });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { inputArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }); });
        ['dragenter', 'dragover'].forEach(eventName => { inputArea.addEventListener(eventName, () => inputArea.classList.add('drag-over')); });
        ['dragleave', 'drop'].forEach(eventName => { inputArea.addEventListener(eventName, () => inputArea.classList.remove('drag-over')); });
        inputArea.addEventListener('drop', (e) => { const files = e.dataTransfer?.files; if (files) { processFiles(files); } });
        function createImagePreview(dataUrl, file) { const previewWrapper = document.createElement('div'); previewWrapper.className = 'relative'; const img = document.createElement('img'); img.src = dataUrl; img.className = 'h-16 w-16 object-cover rounded-md'; previewWrapper.appendChild(img); const removeBtn = document.createElement('button'); removeBtn.innerHTML = '&times;'; removeBtn.className = 'absolute top-0 right-0 -mt-1 -mr-1 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs leading-none'; removeBtn.onclick = () => { uploadedImages = uploadedImages.filter(img => img.file !== file); previewWrapper.remove(); updateImageCount(); }; previewWrapper.appendChild(removeBtn); imagePreviewContainer.appendChild(previewWrapper); }
        function updateImageCount() { imageInfo.classList.remove('text-red-500'); if (uploadedImages.length > 0) { imageInfo.textContent = `Ðã t?i lên ${uploadedImages.length}/${MAX_IMAGES} ?nh.`; } else { imageInfo.textContent = ''; } }
        function appendMessage(data, sender, isError = false) { const { text, images } = data; const messageWrapper = document.createElement('div'); messageWrapper.className = `flex items-start gap-3 mb-4 ${sender === 'user' ? 'justify-end' : ''}`; const messageContent = document.createElement('div'); messageContent.className = `p-3 rounded-lg max-w-xs md:max-w-md lg:max-w-xl ${sender === 'user' ? 'bg-blue-600 text-white' : isError ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200' : 'bg-gray-200 dark:bg-gray-700'}`; if (images && images.length > 0) { const imageGrid = document.createElement('div'); imageGrid.className = 'grid grid-cols-3 gap-1'; images.forEach(file => { const img = document.createElement('img'); img.src = URL.createObjectURL(file); img.className = 'w-full h-auto object-cover rounded'; img.onload = () => URL.revokeObjectURL(img.src); imageGrid.appendChild(img); }); messageContent.appendChild(imageGrid); } if (text) { const textElement = document.createElement('p'); textElement.className = `text-sm ${sender === 'bot' && !isError ? 'text-gray-800 dark:text-gray-200' : ''} ${(images && images.length > 0) ? 'mt-2' : ''}`; textElement.innerHTML = text.replace(/\n/g, '<br>'); messageContent.appendChild(textElement); } const avatar = document.createElement('div'); avatar.className = 'flex-shrink-0 h-10 w-10 rounded-full flex items-center justify-center font-bold text-white'; if (sender === 'user') { avatar.className += ' bg-gray-500'; avatar.textContent = 'U'; messageWrapper.appendChild(messageContent); messageWrapper.appendChild(avatar); } else { avatar.className += isError ? ' bg-red-500' : ' bg-blue-500'; avatar.textContent = 'B'; messageWrapper.appendChild(avatar); messageWrapper.appendChild(messageContent); } const mainChatContainer = document.querySelector('.chat-container'); mainChatContainer.appendChild(messageWrapper); mainChatContainer.scrollTop = mainChatContainer.scrollHeight; }
        function toggleLoading(isLoading) { sendButton.disabled = isLoading; userInput.disabled = isLoading; document.getElementById('image-upload-button').style.pointerEvents = isLoading ? 'none' : 'auto'; sendText.classList.toggle('hidden', isLoading); loadingSpinner.classList.toggle('hidden', !isLoading); if (!isLoading) { userInput.focus(); } }

        // Start the application
        main();
    </script>
</body>
</html>